<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ML Route Optimizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-top: 20px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4 text-center">üöö ML Route Optimizer</h2>

  <!-- FORM -->
  <form method="POST" class="card p-4 shadow-sm bg-white">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Region:</label>
        <select id="region" name="region" class="form-select" required>
          <option value="1">West</option>
          <option value="2">Midwest</option>
          <option value="3">South</option>
          <option value="4">Northeast</option>
          <option value="5">Southeast</option>
        </select>
      </div>

      <div class="col-md-4 normal-mode">
        <label class="form-label">Start City:</label>
        <select id="start_city" name="start_city" class="form-select"></select>
      </div>

      <div class="col-md-4 normal-mode">
        <label class="form-label">End City:</label>
        <select id="end_city" name="end_city" class="form-select"></select>
      </div>

      <div class="col-md-12">
        <label class="form-label">Optimization Strategy:</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="express" id="express_no" value="no" checked>
          <label class="form-check-label" for="express_no">Normal Route</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="express" id="express_yes" value="yes">
          <label class="form-check-label" for="express_yes">üöÄ Express Time Route</label>
        </div>

        <div class="normal-mode mt-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="compare" id="single" value="no" checked>
            <label class="form-check-label" for="single">Single Strategy</label>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <select name="optimize_for" class="form-select" id="optimize_for">
                <option value="time">Time</option>
                <option value="distance">Distance</option>
                <option value="weather">Weather</option>
                <option value="combined">Combined</option>
              </select>
            </div>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="compare" id="compare" value="yes">
            <label class="form-check-label" for="compare">Compare All Strategies</label>
          </div>
        </div>

        <div class="express-mode mt-3" style="display: none;">
          <label class="form-label">Select 2‚Äì5 Cities:</label>
          <select id="express_cities" name="express_cities" class="form-select" multiple required></select>
          <small class="text-muted">Hold Ctrl (or Cmd) to select multiple cities</small>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Find Route</button>
  </form>

  <!-- ROUTE RESULT -->
  {% if result %}
  <div class="card mt-4 p-4 shadow-sm bg-white">
    <h4>üß≠ Route Result ‚Äî Optimized for {{ result.optimized_for.title() }}</h4>
    <p><strong>Region:</strong> {{ region_label }}</p>
    {% if result.optimized_for != 'express' %}
    <p><strong>Start City:</strong> {{ start_label }} &nbsp;&nbsp;
       <strong>End City:</strong> {{ end_label }}</p>
    {% else %}
    <p><strong>Cities:</strong> {{ express_cities | join(" ‚Üí ") }}</p>
    {% endif %}
    <p><strong>Path:</strong> {{ result.path | join(" ‚Üí ") }}</p>
    <p><strong>Total Distance:</strong> {{ result.total_distance }} miles</p>
    <p><strong>Total Time:</strong> {{ result.total_time }} hours</p>
    {% if result.avg_weather_risk is defined %}
    <p><strong>Weather Risk:</strong> {{ result.avg_weather_risk }} (scale 1‚Äì5)</p>
    {% endif %}
    <a id="download" class="btn btn-success mt-2" download="route.csv">‚¨áÔ∏è Download CSV</a>
  </div>

  <div id="map"></div>
  {% endif %}

  <!-- COMPARISON TABLE -->
  {% if comparison_table %}
  <div class="card mt-4 p-4 shadow-sm bg-white">
    <h4>üìä Comparison of All Strategies</h4>
    <p><strong>Region:</strong> {{ region_label }}</p>
    <p><strong>Start City:</strong> {{ start_label }} &nbsp;&nbsp;
       <strong>End City:</strong> {{ end_label }}</p>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          {% for col in comparison_columns %}
          <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in comparison_table %}
        <tr>
          {% for col in comparison_columns %}
          <td>{{ row[col] }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const cityRegions = {
    1: [...Array(10)].map((_, i) => `C${i + 1}`),
    2: [...Array(10)].map((_, i) => `C${i + 11}`),
    3: [...Array(10)].map((_, i) => `C${i + 21}`),
    4: [...Array(10)].map((_, i) => `C${i + 31}`),
    5: [...Array(10)].map((_, i) => `C${i + 41}`)
  };

  function populateCities(regionId) {
    const cities = cityRegions[regionId] || [];
    const start = document.getElementById('start_city');
    const end = document.getElementById('end_city');
    const express = document.getElementById('express_cities');

    start.innerHTML = '';
    end.innerHTML = '';
    express.innerHTML = '';
    cities.forEach(city => {
      start.appendChild(new Option(city, city));
      end.appendChild(new Option(city, city));
      express.appendChild(new Option(city, city));
    });
  }

  document.getElementById('region').addEventListener('change', function () {
    populateCities(parseInt(this.value));
  });

  // Express toggle logic
  function toggleExpressUI() {
    const express = document.getElementById("express_yes").checked;
    document.querySelectorAll(".normal-mode").forEach(el => el.style.display = express ? "none" : "block");
    document.querySelectorAll(".express-mode").forEach(el => el.style.display = express ? "block" : "none");
  }

  document.getElementById("express_yes").addEventListener("change", toggleExpressUI);
  document.getElementById("express_no").addEventListener("change", toggleExpressUI);
  toggleExpressUI();
  populateCities(parseInt(document.getElementById('region').value || "1"));

  {% if result %}
  const cityCoords = {
    {% for city, coord in city_coords.items() %}
    "{{ city }}": [{{ coord[0] }}, {{ coord[1] }}],
    {% endfor %}
  };

  const path = {{ result.path | tojson }};
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const latlngs = [];
  path.forEach(city => {
    const coord = cityCoords[city];
    latlngs.push(coord);
    L.marker(coord, {
      icon: L.divIcon({
        html: `<div style="background:white;border:2px solid black;border-radius:50%;width:30px;height:30px;line-height:28px;text-align:center;">${city}</div>`,
        className: '',
        iconAnchor: [15, 15]
      })
    }).addTo(map);
  });

  L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);
  map.fitBounds(latlngs);

  const csv = ["Step,City"];
  path.forEach((city, i) => csv.push(`${i + 1},${city}`));
  const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
  document.getElementById('download').href = URL.createObjectURL(blob);
  {% endif %}
</script>
</body>
</html>
